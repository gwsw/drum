<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title> Drum Patterns </title>
</head>

<body onload="init()">

<table>
<tr><td> Pattern: </td><td> <input type="text" id="pattern" size="30"> </td></tr>
<tr><td> BPM: </td><td> <input type="number" id="bpm" value="90" onchange="input_bpm()"> </td></tr>
<tr><td></td><td> <input type="button" id="play_btn" value="Play" onclick="click_play()"> </td></tr>
</table>

<p id="msg" style="color:red"></p>

<script>

// Constants
var bpm            = 90;
var bass_freq      = 120;
var snare_freq     = 200;
var hihat_freq     = 400;
var drum_dur       = 100;
var notes_per_bar  = 16;
var beats_per_bar  = 4;
var notes_per_beat = notes_per_bar / beats_per_bar;

// Globals
var graph = null;
var music_bar = null;
var next_play = -1;

// -------------------------------------------------------------------
class AudioGraph {
    constructor() {
        this.audio = new (window.AudioContext || window.webkitAudioContext);
        this.gain = this.audio.createGain();
        this.set_gain(0);
        this.gain.connect(this.audio.destination);
        this.osc = this.audio.createOscillator();
        this.osc.connect(this.gain);
        this.osc.start(0);
    }
    tone(freq, dur) {
        this.osc.frequency.value = freq;
        this.set_gain(1);
        ///FIXME window.setTimeout(function() { this.set_gain(0); }, dur);
        window.setTimeout(AudioGraph_stop, dur);
    }
    set_gain(gain) {
        this.gain.gain.setValueAtTime(gain, this.audio.currentTime);
    }
};
function AudioGraph_stop() {
    graph.gain.gain.setValueAtTime(0, graph.audio.currentTime);
}

// -------------------------------------------------------------------
class MusicBar {
    constructor(pattern) {
        this.freqs = [];
        for (let i = 0; i < 16; ++i) {
            this.freqs.push([]);
        }
        let note = -1;
        let freq = 0;
        pattern += ' ';
        for (const ch of pattern.split('')) {
            if (ch == '\r' || ch == '\n') {
                ;
            } else if (ch == ' ' || ch == ',') {
                if (note >= 0) {
                    this.freqs[note].push(freq);
                    note = -1;
                }
            } else if (ch == 'b') {
                freq = bass_freq;
            } else if (ch == 's') {
                freq = snare_freq;
            } else if (ch == 'h') {
                freq = hihat_freq;
            } else if (ch == '1') {
                note = 0;
            } else if (ch == '2') {
                note = notes_per_beat;
            } else if (ch == '3') {
                note = 2*notes_per_beat;
            } else if (ch == '4') {
                note = 3*notes_per_beat;
            } else if (ch == '&') {
                note += notes_per_beat/2;
            } else if (ch == 'e') {
                note += notes_per_beat/4;
            } else if (ch == 'u') {
                note += 3*notes_per_beat/4;
            } else {
                msg("Invalid character '"+ch+"' in pattern.");
            }
        }
    }
    freq(idx) {
        return this.freqs[idx % this.freqs.length];
    }
}

// -------------------------------------------------------------------

function init() {
    graph = new AudioGraph();
}

function click_play() {
    msg("");
    const pattern = el("pattern").value;
    music_bar = new MusicBar(pattern);
    let btn = el("play_btn");
    if (next_play >= 0) {
        btn.value = "Play";
        next_play = -1;
    } else {
        btn.value = "Stop";
        next_play = 0;
        next();
    }
}

function input_bpm() {
    bpm = el("bpm").value;
}

function next() {
    if (next_play < 0) return;
    for (const freq of music_bar.freq(next_play)) {
        graph.tone(freq, drum_dur);
    }
    ++next_play;
    const interval = (60*1000 * beats_per_bar) / (bpm * notes_per_bar);
    window.setTimeout(next, interval);
}

function msg(s) {
    el("msg").innerHTML = s;
}

function now() {
    return performance.now();
}

function el(id) {
    return document.getElementById(id);
}

</script>
</body>
