<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title> Drum Patterns </title>
</head>

<body onload="init()">

<table>
<tr><td> Pattern: </td><td> <input type="text" id="pattern" size="30"> </td></tr>
<tr><td> BPM: </td><td> <input type="number" id="bpm" value="90" oninput="input_bpm()"> </td></tr>
<tr><td></td><td> <input type="button" id="play_btn" value="Play" onclick="click_play()"> </td></tr>
</table>

<span id="msg">hi</span>

<script>

var audio = null;
var gain = null;
var osc = null;
var timeline = null;
var next_play = -1;
var start;

var bass_freq = 120;
var snare_freq = 200;
var drum_dur = 100;
var notes_per_bar = 16;
var beats_per_bar = 4;
var bpm = 90;

class AudioGraph {
}

function init() {
    audio = new (window.AudioContext || window.webkitAudioContext);
    gain = audio.createGain();
    gain.gain.setValueAtTime(0, audio.currentTime);
    gain.connect(audio.destination);

    osc = audio.createOscillator();
    osc.connect(gain);
    //osc.frequency.value = 400;
    osc.start(0);
}

function click_play() {
    ///let pattern = el("pattern").value;
    timeline = [];
    for (let i = 0; i < 16; ++i) {
        timeline.push([]);
    }

timeline[0].push(snare_freq);
timeline[4].push(bass_freq);
timeline[8].push(snare_freq);
timeline[12].push(bass_freq);
timeline[14].push(bass_freq);

    let btn = el("play_btn");
    if (next_play >= 0) {
        btn.value = "Play";
        next_play = -1;
    } else {
        btn.value = "Stop";
        next_play = 0;
        next();
    }
}

function input_bpm() {
    bpm = el("bpm").value;
}

function next() {
    if (next_play < 0) return;
    for (const freq of timeline[next_play % 16]) {
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(1, audio.currentTime);
        window.setTimeout(stop_osc, drum_dur);
    }
    ++next_play;
    const notes_per_beat = notes_per_bar / beats_per_bar;
    const interval = (60*1000 * beats_per_bar) / (bpm * notes_per_bar);
    window.setTimeout(next, interval);
}

function stop_osc() {
    gain.gain.setValueAtTime(0, audio.currentTime);
}

function now() {
    return performance.now();
}

function el(id) {
    return document.getElementById(id);
}

</script>
</body>
